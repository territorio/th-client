require "rake-pipeline-web-filters"
require 'rake-pipeline-i18n-filters'
require 'rake-pipeline-web-filters/filter_with_dependencies'
require 'compass'

Encoding.default_external = Encoding::UTF_8
Encoding.default_internal = Encoding::UTF_8

class AddMicroLoader < Rake::Pipeline::Filter
  LOADER = File.expand_path("../app/submodules/ember.js/packages/loader/lib/main.js", __FILE__)

  def initialize(options={}, &block)
    super(&block)
    @global = options[:global]
  end

  def generate_output(inputs, output)
    output.write "(function() {\n" unless @global

    output.write File.read(LOADER)

    inputs.each do |input|
      output.write input.read
    end

    output.write "\n})();\n" unless @global
  end

  def additional_dependencies(input)
    [ LOADER ]
  end
end


# vim: filetype=ruby
